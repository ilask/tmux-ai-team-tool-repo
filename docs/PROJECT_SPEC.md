# Project Specification & Migration Plan: aiteam v2

## 1. PythonからNode.js (TypeScript) への移行計画

現在の `tmux` に依存したハック的なPythonスクリプトから、堅牢なプロセス間通信 (IPC/WebSocket) を用いたNode.jsベースのアプリケーションへ完全移行します。

### フェーズ分け
*   **Phase 1: 基盤構築**
    *   Node.js (TypeScript) プロジェクトの初期化
    *   ESLint, Prettier, Vitest などの開発環境整備
    *   Central Hub (WebSocket/JSON-RPC サーバー) のコア実装
*   **Phase 2: アダプター実装**
    *   Codex Adapter: `codex app-server` とのJSON-RPC連携
    *   Claude Adapter: `claude --print --input-format=stream-json --output-format=stream-json` のストリームパース処理
    *   Gemini Adapter: Gemini CLI の標準入出力ストリームラッパー
*   **Phase 3: CLIクライアント実装**
    *   ユーザー向けの新しいUIクライアント (ターミナルまたはウェブ)
    *   Hubサーバーとの通信プロトコル実装
*   **Phase 4: テストと安定化**
    *   E2EテストスイートのVitestへの移行
    *   Windows/macOS/Linuxでのクロスプラットフォーム動作確認

## 2. Node.js ベストプラクティス開発環境構築

モダンかつ堅牢な TypeScript 開発環境を構築します。運用のためのハードスペックは以下の通りです。

*   **ランタイム:** Node.js v20 LTS (`.nvmrc` で固定)
*   **パッケージマネージャ:** `pnpm` (Corepackでバージョン固定)
*   **言語:** TypeScript (Strict mode)
*   **実行環境/ビルド:** `tsx` を用いた開発実行。ビルドツールには `tsup` を採用しCLIバイナリを生成。
*   **リンター/フォーマッター:** ESLint (Flat Config) + Prettier。`lint-staged` と `husky` で自動整形。
*   **テストフレームワーク:** Vitest。高速な実行と強力なモック機能、型安全なテストを活用。
*   **バリデーション:** Zod。外部プロセスからのJSONストリーム入力に対する型安全なパースとバリデーションに使用。
*   *(Note: 初期フェーズでは開発速度を優先し、完全なCIマトリクスや複雑なリリースパイプラインの構築はPhase 4以降の課題とする。)*

## 3. Claude Code "Agent Teams" リサーチとユースケース

**(調査日: 2026年2月21日 | ソース: https://code.claude.com/docs/en/agent-teams)**

Web検索の結果、「Claude Code Agent Teams」は以下のような特徴を持つことがわかりました。
*   **概要:** "チームリード"（メインセッション）が"チームメイト"（サブエージェント）を起動し、複雑なタスクを並行処理する仕組み。現在Experimental（実験的）な機能であり、トークン消費が激しい点に留意が必要。
*   **連携方式:** サブエージェント同士が共有タスクリストとインボックス（メッセージング）を通じて直接会話・調整・反論を行う。
*   **メリット:** コンテキストの劣化を防ぎ、専門的なサブエージェントが並行して動くことで速度と品質が向上する。

### 一般的なユースケース
1.  **大規模リファクタリング:** 1人がコードを書き換え、もう1人が同時にテストを修正する。
2.  **フロントエンド＆バックエンド連携:** 1人がAPIエンドポイントを設計・実装し、もう1人が同時にそれに合わせたフロントエンドコンポーネントを作成する。

## 4. Gemini, Claude Code, Codex CLI 協業のAgent Teamsユースケース

**【重要】ネイティブなAgent Teamsと、カスタムオーケストレーションの違い:**
Claude Code自身が持つAgent Teams機能は「単一ベンダー内の連携」ですが、本プロジェクト（aiteam v2）は、**「Gemini, Claude, Codexの3者を跨いだクロスベンダーのカスタムオーケストレーション（独自のHubサーバー介在）」**を目指します。

各ツールの強みを活かした独自の Agent Teams コンセプトです。
*   **ユースケースA: 高速プロトタイピングとアーキテクチャ設計**
    *   **Gemini (リード/設計):** ユーザーと対話し、要求仕様からアーキテクチャ設計とタスク分割を行う。Web検索能力を活かして最新のライブラリ情報も収集。
    *   **Claude Code (コーディング/実装):** Geminiが分割したタスクに基づき、堅牢なTypeScriptのコードを実装する。
    *   **Codex CLI (環境構築/インフラ):** Dockerfileの生成、CI/CDの設定、シェルスクリプトによる自動環境構築を担う。
*   **ユースケースB: バグの自動調査と修正パッチ作成**
    *   **Gemini (ログ解析/トリアージ):** エラーログを読み解き、問題の切り分けと発生箇所のアタリをつける。
    *   **Codex CLI (OS/シェル操作):** サーバーやコンテナ内でコマンドを実行し、実際の状態（プロセス、ファイル）を調査して情報をGeminiに返す。
    *   **Claude Code (修正提案):** 原因が特定されたのち、修正コードとテストを実装する。

## 5. アーキテクチャ変更計画：スター型から「密結合型（ヘッドレス）」へ

従来の「全エージェントがターミナルのペイン（UI）を持ち、tmux越しに文字を送り合う（スター型）」アプローチを廃止します。

*   **新コンセプト:** ユーザーが直接対話するのは**1つのリードエージェントのUIのみ**。他のエージェントはバックグラウンドで「ヘッドレス（画面なし）」として起動し、プロセス間通信（JSONストリーム/WebSocket）で完全に密結合に連携します。
*   **メリット:**
    *   tmuxのような画面分割ツールが不要になり、Windows含む全OSでネイティブ動作。
    *   データ通信がプレーンテキストから構造化データ（JSON）になるため、情報の欠落やパースエラーが激減する。
*   **運用上の制約 (Constraints):**
    *   メモリとトークン消費を抑えるため、同時にアクティブになるヘッドレスエージェントは上限（例：3つ）を設ける。

## 6. 新アーキテクチャ用 E2E テストケース

Vitest を用いて、新アーキテクチャ（Node.js Hub + Headless Agents）のE2Eテストを実装します。ストリーム特有の失敗モード網羅に注力します。

### テストケース1: ヘッドレスプロセスの起動と接続確認
*   **目的:** Central Hub が各アダプタープロセスをヘッドレスで正常に起動し、通信チャネルが確立できるか。

### テストケース2: リードからヘッドレスエージェントへのメッセージルーティング
*   **目的:** 密結合されたエージェント間で、Hubを介したメッセージパッシング（依頼と結果の受領）が順序保証（Ordering）をもって正常に行われるか。

### テストケース3: 共有タスク（インボックス）の並行処理とバックプレッシャー
*   **目的:** 複数エージェントによる並列タスク実行と完了報告の統合をテストする。また、大量のJSONストリームが流れた際のバックプレッシャー（負荷制御）が機能するか確認する。

### テストケース4: プロセスクラッシュ時のリカバリとエラー伝搬 (クロスプラットフォーム対応)
*   **目的:** ヘッドレスプロセスが予期せず終了した際の堅牢性を担保する。
*   **検証:** Windows環境でも安全に動作する終了処理（SIGKILLに依存しないGraceful Shutdown、もしくはタスクキル）が機能し、不正なJSONを受信した際（Malformed JSON）にHubがクラッシュせず適切にエラーをリードエージェントにルーティングできるか。